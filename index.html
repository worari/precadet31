<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดเก็บข้อมูลกำลังพล</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.tailwindcss.css">
    <script src="https://cdn.datatables.net/2.0.7/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.7/js/dataTables.tailwindcss.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
        }

        /* --- [START] Modern DataTables Styles --- */

        /* ปรับปรุงสไตล์ของ 'Show entries' select box */
        .dataTables_wrapper .dataTables_length select {
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #d1d5db; /* border-gray-300 */
            padding: 0.5rem 2rem 0.5rem 0.75rem; 
            background-color: white; /* bg-white */
            font-size: 0.875rem; /* text-sm */
        }
        
        /* ปรับปรุงสไตล์ของ 'Showing X to Y' info text */
        .dataTables_info {
             font-size: 0.875rem; /* text-sm */
             color: #4b5563; /* text-gray-600 */
             padding-top: 0.5rem; /* เพิ่ม padding เพื่อจัดแนวให้สวยงาม */
        }
        
        /* ปรับปรุงสไตล์ปุ่ม Pagination (ตัวเลขหน้า) */
        .dt-paging .dt-paging-button {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 2.25rem; /* h-9 */
            width: 2.25rem; /* w-9 */
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #d1d5db; /* border-gray-300 */
            background-color: white;
            color: #374151; /* text-gray-700 */
            margin-left: 0.25rem;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
        }
        
        /* เอฟเฟกต์ Hover ของปุ่ม Pagination */
        .dt-paging .dt-paging-button:hover {
             background-color: #f9fafb; /* bg-gray-50 */
             border-color: #9ca3af; /* border-gray-400 */
        }

        /* สไตล์ปุ่ม Pagination ที่ถูกเลือก (Current) */
        .dt-paging .dt-paging-button.current,
        .dt-paging .dt-paging-button.current:hover {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
            border-color: #2563eb; /* border-blue-600 */
            font-weight: 600;
        }

        /* สไตล์ปุ่ม Pagination ที่ถูกปิดใช้งาน (Disabled) */
        .dt-paging .dt-paging-button.disabled,
        .dt-paging .dt-paging-button.disabled:hover {
            background-color: #f9fafb; /* bg-gray-50 */
            color: #9ca3af; /* text-gray-400 */
            border-color: #e5e7eb; /* border-gray-200 */
            cursor: not-allowed;
        }

        /* ปรับปรุงสไตล์ของตาราง (Header) */
         #personnel-table thead th {
             padding: 0.75rem 1.5rem; /* py-3 px-6 */
             vertical-align: middle;
             /* คลาสสีและตัวอักษรถูกกำหนดไว้ใน HTML (bg-gray-50, etc.) */
         }

        /* ปรับปรุงสไตล์ของตาราง (Body) */
        #personnel-table tbody tr {
            border-bottom: 1px solid #e5e7eb; /* border-b border-gray-200 */
        }

        /* เอฟเฟกต์ Hover ของแถวในตาราง */
        #personnel-table tbody tr:hover {
            background-color: #f9fafb; /* bg-gray-50 */
        }
        
        /* ปรับปรุงสไตล์ของเซลล์ในตาราง (Body) */
        #personnel-table tbody td {
            padding: 1rem 1.5rem; /* py-4 px-6 */
            white-space: nowrap;
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
            vertical-align: middle; /* จัดให้เนื้อหาอยู่กึ่งกลางแนวตั้ง */
        }

        /* --- [END] Modern DataTables Styles --- */


        .form-select, .form-input {
            border-radius: 0.5rem;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #374151;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .btn-warning {
             background-color: #f59e0b;
             color: white;
        }
        .btn-warning:hover {
            background-color: #d97706;
        }
        .btn-info {
            background-color: #0ea5e9;
            color: white;
        }
        .btn-info:hover {
            background-color: #0284c7;
        }
        
        /* Hide print area by default */
        #print-area {
            display: none;
        }
        
        /* Modal Styles */
        #form-modal-backdrop {
            z-index: 40; /* backdrop */
        }
        #form-modal {
            z-index: 50; /* modal content */
        }
        
        /* Print-specific styles */
        @media print {
            /* Hide everything in the body by default */
            body * {
                visibility: hidden;
            }
            /* Make the print area and its children visible */
            #print-area, #print-area * {
                visibility: visible;
            }
            /* Ensure the print area is displayed as a block */
            #print-area {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            /* Hide elements that should not be printed */
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl font-bold text-gray-800">ระบบจัดเก็บข้อมูลกำลังพล</h1>
            <p class="text-gray-600 mt-2">จัดการข้อมูลส่วนบุคคล ที่อยู่ และเอกสารสำคัญของบุคลากร</p>
        </header>

        <div class="card no-print">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">รายชื่อบุคลากร</h2>
            
            <div class="flex flex-wrap gap-2 mb-4">
                <input type="text" id="name-search-input" class="block w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input" placeholder="ค้นหาด้วยชื่อ หรือ สกุล...">
                <button type="button" id="search-btn" class="btn btn-primary text-sm">ค้นหา</button>
                <button type="button" id="show-all-btn" class="btn btn-secondary text-sm">แสดงทั้งหมด</button>
                <button type="button" id="add-new-btn" class="btn btn-primary text-sm ml-auto">เพิ่มข้อมูลใหม่</button>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
                 <button id="print-pdf-btn" class="btn btn-info text-sm">พิมพ์รายงาน PDF</button>
                 <button id="export-excel-btn" class="btn btn-info text-sm bg-green-600 hover:bg-green-700">ส่งออกเป็น Excel</button>
                 <button id="create-doc-btn" class="btn btn-info text-sm disabled:opacity-50" disabled>สร้างประวัติ (Google Doc)</button>
            </div>
            <div class="overflow-x-auto">
                <table id="personnel-table" class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">ID</th>
                            <th class="px-6 py-3">ยศ-ชื่อ-สกุล</th>
                            <th class="px-6 py-3">สังกัด</th>
                            <th class="px-6 py-3">ตำแหน่ง</th>
                            <th class="px-6 py-3">เบอร์โทร</th>
                            <th class="px-6 py-3">ปีเกษียณ</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="print-area">
             <h1 class="text-2xl font-bold text-center mb-6">รายงานข้อมูลกำลังพล</h1>
             <div id="printable-content"></div>
        </div>
    </div>

    <div id="form-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden no-print"></div>
    <div id="form-modal" class="fixed inset-0 overflow-y-auto hidden no-print">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl mx-auto relative">
                <button id="close-modal-btn" type="button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                
                <form id="personnel-form" class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">ข้อมูลส่วนบุคคล</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="rank" class="block text-sm font-medium text-gray-700">ยศ</label>
                                    <select id="rank" name="rank" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-select">
                                        <option>พล.อ.</option><option>พล.ท.</option><option>พล.ต.</option>
                                        <option>พ.อ.(พ.)</option><option>พ.อ.</option><option>พ.ท.</option><option>พ.ต.</option>
                                        <option value="อื่นๆ">อื่นๆ</option>
                                    </select>
                                </div>
                                <div id="rank_other_wrapper" class="hidden">
                                    <label for="rank_other" class="block text-sm font-medium text-gray-700">ระบุยศอื่นๆ</label>
                                    <input type="text" id="rank_other" name="rank_other" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="fname" class="block text-sm font-medium text-gray-700">ชื่อ</label>
                                    <input type="text" id="fname" name="fname" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="lname" class="block text-sm font-medium text-gray-700">สกุล</label>
                                    <input type="text" id="lname" name="lname" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="nickname" class="block text-sm font-medium text-gray-700">ชื่อเล่น</label>
                                    <input type="text" id="nickname" name="nickname" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="birthday" class="block text-sm font-medium text-gray-700">วันเกิด</label>
                                    <input type="date" id="birthday" name="birthday" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700">เบอร์โทร</label>
                                    <input type="tel" id="phone" name="phone" required pattern="[0-9]{9,10}" placeholder="08xxxxxxxx" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="email" name="email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="affiliation" class="block text-sm font-medium text-gray-700">สังกัด</label>
                                    <select id="affiliation" name="affiliation" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-select">
                                        <option>ทบ.</option><option>สป.กห.</option><option>ทท.</option><option>สทป.</option><option value="อื่นๆ">อื่นๆ</option>
                                    </select>
                                </div>
                                <div id="affiliation_other_wrapper" class="hidden">
                                    <label for="affiliation_other" class="block text-sm font-medium text-gray-700">ระบุสังกัดอื่นๆ</label>
                                    <input type="text" id="affiliation_other" name="affiliation_other" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                 <div>
                                    <label for="position" class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                                    <input type="text" id="position" name="position" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="corps" class="block text-sm font-medium text-gray-700">เหล่า</label>
                                    <select id="corps" name="corps" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-select">
                                        <option>ร.</option><option>ม.</option><option>ป.</option><option>ช.</option><option>ส.</option>
                                        <option>สพ.</option><option>ขส.</option><option>พธ.</option><option>สห.</option><option>ผท.</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="retirement_year" class="block text-sm font-medium text-gray-700">ปีเกษียณ (พ.ศ.)</label>
                                    <input type="number" id="retirement_year" name="retirement_year" min="2567" max="2650" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                                <div>
                                    <label for="marital_status" class="block text-sm font-medium text-gray-700">สถานภาพ</label>
                                    <select id="marital_status" name="marital_status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-select">
                                        <option>โสด</option><option>สมรส</option><option>หย่าร้าง</option><option>หม้าย</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="children_count" class="block text-sm font-medium text-gray-700">จำนวนบุตร</label>
                                    <input type="number" id="children_count" name="children_count" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">ข้อมูลที่อยู่และรูปภาพ</h2>
                            <div>
                                <label for="house_number" class="block text-sm font-medium text-gray-700">บ้านเลขที่</label>
                                <input type="text" id="house_number" name="house_number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                            </div>
                            <div class="mt-4">
                                <label for="road" class="block text-sm font-medium text-gray-700">ถนน</label>
                                <input type="text" id="road" name="road" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                            </div>
                            <div class="mt-4">
                                <label for="sub_district" class="block text-sm font-medium text-gray-700">ตำบล/แขวง</label>
                                <input type="text" id="sub_district" name="sub_district" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                            </div>
                            <div class="mt-4">
                                <label for="district" class="block text-sm font-medium text-gray-700">อำเภอ/เขต</label>
                                <input type="text" id="district" name="district" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                            </div>
                            <div class="mt-4">
                                <label for="province" class="block text-sm font-medium text-gray-700">จังหวัด</label>
                                <input type="text" id="province" name="province" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                            </div>
                            <div class="mt-4">
                                <label for="zipcode" class="block text-sm font-medium text-gray-700">รหัสไปรษณีย์</label>
                                <input type="text" id="zipcode" name="zipcode" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 form-input">
                            </div>
                            <div class="mt-4">
                                <label for="profile_pic" class="block text-sm font-medium text-gray-700">รูปภาพโปรไฟล์</label>
                                <input type="file" id="profile_pic" name="profile_pic" accept=".jpg, .jpeg, .png" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <img id="image_preview" src="https://placehold.co/200x200/e2e8f0/adb5bd?text=Preview" alt="Profile preview" class="mt-4 rounded-md w-48 h-48 object-cover mx-auto">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 justify-center mt-6">
                        <input type="hidden" id="recordId" name="id"> <button type="submit" id="save-btn" class="btn btn-primary">บันทึกข้อมูล</button>
                        <button type="button" id="update-btn" class="btn btn-warning hidden">อัปเดตข้อมูล</button>
                        <button type="button" id="delete-btn" class="btn btn-danger hidden">ลบข้อมูล</button>
                        <button type="button" id="clear-btn" class="btn btn-secondary">ล้างฟอร์ม</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
    $(document).ready(function() {
        // --- GLOBAL VARIABLES ---
        let personnelData = []; // This will store the MASTER list of all personnel
        let dataTable = null;
        let selectedRowData = null;

        // --- CUSTOM SORTING DEFINITIONS ---
        // Define sorting order for Rank
        const rankOrder = {
            'พล.อ.': 1, 'พล.ท.': 2, 'พล.ต.': 3, 'พ.อ.(พ.)': 4,
            'พ.อ.': 5, 'พ.ท.': 6, 'พ.ต.': 7
        };
        // Define sorting order for Affiliation
        const affiliationOrder = { 'ทบ.': 1, 'สป.กห.': 2, 'ทท.': 3, 'สทป.': 4 };

        // Register custom sorting types with DataTables
        DataTable.ext.type.order['rank-sort-pre'] = function (d) {
            return rankOrder[d] || 99; // Default to 99 for 'อื่นๆ' or unmatched
        };
        DataTable.ext.type.order['affiliation-sort-pre'] = function (d) {
            return affiliationOrder[d] || 99; // Default to 99 for 'อื่นๆ' or unmatched
        };


        // --- MODAL FUNCTIONS ---
        function showModal() {
            $('#form-modal-backdrop').removeClass('hidden');
            $('#form-modal').removeClass('hidden');
        }
        function hideModal() {
            $('#form-modal-backdrop').addClass('hidden');
            $('#form-modal').addClass('hidden');
        }

        // --- INITIALIZATION ---
        function initializeDataTable() {
            if (dataTable) {
                dataTable.destroy();
            }
            dataTable = new DataTable('#personnel-table', {
                responsive: true,
                data: personnelData, // Use the master list for initial load
                
                // 'l' = length, 'r' = processing, 't' = table, 'i' = info, 'p' = pagination
                // 'lrtip' คือ layout เริ่มต้นของ DataTables Tailwind
                dom: 'lrtip', 
                
                pageLength: 10, // [EDIT] Set default page length to 10
                columns: [
                    { data: 'id' },
                    { 
                        data: 'rank',
                        render: (data, type, row) => `${row.rank || ''} ${row.fname || ''} ${row.lname || ''}`
                    },
                    { data: 'affiliation' },
                    { data: 'position' },
                    { data: 'phone' },
                    { data: 'retirement_year' },
                ],
                columnDefs: [
                    { "width": "5%", "targets": 0 },
                    { type: 'rank-sort', "targets": 1 }, // Apply custom rank sort to column 1
                    { type: 'affiliation-sort', "targets": 2 } // Apply custom affiliation sort to column 2
                ],
                // Default sort by Rank (col 1) then Affiliation (col 2)
                order: [
                    [1, 'asc'], 
                    [2, 'asc']
                ]
            });

            $('#personnel-table tbody').on('click', 'tr', function () {
                if ($(this).hasClass('bg-blue-200')) {
                    $(this).removeClass('bg-blue-200');
                    clearForm();
                    selectedRowData = null;
                } else {
                    dataTable.$('tr.bg-blue-200').removeClass('bg-blue-200');
                    $(this).addClass('bg-blue-200');
                    selectedRowData = dataTable.row(this).data();
                    populateForm(selectedRowData);
                }
                 $('#create-doc-btn').prop('disabled', !selectedRowData);
            });
        }

        // --- DATA HANDLING ---
        function loadData() {
            Swal.fire({
                title: 'กำลังโหลดข้อมูล...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            console.log("Attempting to call server function 'getData'..."); // [DEBUG]
            google.script.run
                .withSuccessHandler(function(response) {
                    Swal.close();
                     console.log("Server response received for 'getData':", response); // [DEBUG]
                    // [FIX] Add check for null or undefined response
                    if (response && response.success && response.data) {
                        console.log("Data load success:", response.data.length, "rows"); // [DEBUG]
                        personnelData = response.data; // Store the master list
                        initializeDataTable(); // Initialize table with master list
                    } else {
                        // Handle cases where response is null or response.success is false
                        const errorMessage = response ? response.message : 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์ (อาจหมดเวลา)';
                        Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถโหลดข้อมูลได้: ' + errorMessage, 'error');
                        console.error('Error loading data, server response:', response);
                    }
                })
                .withFailureHandler(function(error) {
                    Swal.close();
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว', 'error');
                    console.error('Error loading data:', error);
                })
                .getData();
        }
        
        function handleSave(formData) {
            const serverFunction = formData.id ? 'updateData' : 'saveData';
            const actionText = formData.id ? 'อัปเดต' : 'บันทึก';
            
            Swal.fire({
                title: `กำลัง${actionText}ข้อมูล...`,
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            google.script.run
                .withSuccessHandler(function(response) {
                     if (response && response.success && response.data) {
                         Swal.fire('สำเร็จ!', `${actionText}ข้อมูลเรียบร้อยแล้ว`, 'success');
                         hideModal();
                         loadData(); // Reload all data from server to get the master list updated
                         clearForm();
                     } else {
                         const errorMessage = response ? response.message : 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์';
                         Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถ${actionText}ข้อมูลได้: ${errorMessage}`, 'error');
                     }
                })
                .withFailureHandler(function(error){
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว', 'error');
                })
                [serverFunction](formData);
        }

        function handleDelete(id) {
            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: "คุณจะไม่สามารถกู้คืนข้อมูลนี้ได้!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ใช่, ลบเลย!',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });
                    google.script.run
                        .withSuccessHandler(function(response){
                             if(response && response.success){
                                 Swal.fire('ลบแล้ว!', 'ข้อมูลถูกลบเรียบร้อยแล้ว', 'success');
                                 hideModal();
                                 loadData(); // Reload all data from server
                                 clearForm();
                               } else { 
                                 const errorMessage = response ? response.message : 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์';
                                 Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถลบข้อมูลได้: ${errorMessage}`, 'error');
                               }
                        })
                        .withFailureHandler(function(error){
                             Swal.fire('เกิดข้อผิดพลาด!', `การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว`, 'error');
                        })
                        .deleteData({ id: id });
                }
            });
        }

        // --- FORM HANDLING ---
        $('#personnel-form').on('submit', function(e) {
            e.preventDefault();
            
            const requiredFields = ['fname', 'lname', 'phone', 'affiliation', 'rank'];
            let isValid = true;
            for (const field of requiredFields) {
                const input = $(`#${field}`);
                if (!input.val()) {
                    isValid = false;
                    input.addClass('border-red-500');
                } else {
                    input.removeClass('border-red-500');
                }
            }
            if (!isValid) {
                 Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลในช่องที่จำเป็นให้ครบถ้วน (ชื่อ, สกุล, เบอร์โทร, สังกัด, ยศ)', 'warning');
                 return;
            }

            const formData = {};
            const formArray = $(this).serializeArray();
            $.each(formArray, function(i, field) {
                formData[field.name] = field.value;
            });

            // Handle 'อื่นๆ' for affiliation
            if (formData.affiliation === 'อื่นๆ') {
                formData.affiliation = $('#affiliation_other').val() || 'อื่นๆ';
            }
            // Handle 'อื่นๆ' for rank
            if (formData.rank === 'อื่นๆ') {
                formData.rank = $('#rank_other').val() || 'อื่นๆ';
            }
            
            const file = $('#profile_pic')[0].files[0];
            if(file){
                 const reader = new FileReader();
                 reader.onloadend = function() {
                    formData.profile_pic_base64 = reader.result;
                    formData.profile_pic_filename = file.name;
                    handleSave(formData);
                 }
                 reader.readAsDataURL(file);
            } else {
                 // Keep existing image if not uploading a new one during update
                 formData.profile_pic_base64 = selectedRowData ? selectedRowData.profile_pic_url : null;
                 formData.profile_pic_filename = '';
                 handleSave(formData);
            }
        });

        function populateForm(data) {
            // Populate all form fields from data object
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const el = $(`#${key}`);
                    if (el.length) {
                        el.val(data[key]);
                    }
                }
            }
            
            // Handle 'อื่นๆ' for rank
            const rankOptions = $('#rank option').map((i, el) => el.value).get();
            if (rankOptions.includes(data.rank)) {
                 $('#rank').val(data.rank).trigger('change');
            } else {
                 $('#rank').val('อื่นๆ').trigger('change');
                 $('#rank_other').val(data.rank);
            }

            // Handle 'อื่นๆ' for affiliation
            const affiliations = $('#affiliation option').map((i, el) => el.value).get();
            if (affiliations.includes(data.affiliation)) {
                 $('#affiliation').val(data.affiliation).trigger('change');
            } else {
                 $('#affiliation').val('อื่นๆ').trigger('change');
                 $('#affiliation_other').val(data.affiliation);
            }
            
            $('#image_preview').attr('src', data.profile_pic_url || 'https://placehold.co/200x200/e2e8f0/adb5bd?text=No+Image');
            $('#save-btn').addClass('hidden');
            $('#update-btn, #delete-btn').removeClass('hidden');
            
            showModal(); // Show modal after populating
        }

        function clearForm() {
            $('#personnel-form')[0].reset();
            $('#recordId').val(''); // Clear the hidden ID
            $('#image_preview').attr('src', 'https://placehold.co/200x200/e2e8f0/adb5bd?text=Preview');
            $('#save-btn').removeClass('hidden');
            $('#update-btn, #delete-btn').addClass('hidden');
            $('#affiliation_other_wrapper').addClass('hidden');
            $('#rank_other_wrapper').addClass('hidden');
            if (dataTable) dataTable.$('tr.bg-blue-200').removeClass('bg-blue-200');
            selectedRowData = null;
            $('#create-doc-btn').prop('disabled', true);
        }
        
        // --- EVENT LISTENERS ---
        
        // Modal Listeners
        $('#add-new-btn').on('click', function() {
            clearForm();
            showModal();
        });
        $('#close-modal-btn').on('click', hideModal);
        $('#form-modal-backdrop').on('click', hideModal);

        $('#affiliation').on('change', function() {
            if ($(this).val() === 'อื่นๆ') {
                $('#affiliation_other_wrapper').removeClass('hidden');
            } else {
                $('#affiliation_other_wrapper').addClass('hidden');
                $('#affiliation_other').val('');
            }
        });

        $('#rank').on('change', function() {
            if ($(this).val() === 'อื่นๆ') {
                $('#rank_other_wrapper').removeClass('hidden');
            } else {
                $('#rank_other_wrapper').addClass('hidden');
                $('#rank_other').val('');
            }
        });

        $('#profile_pic').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                 if(file.size > 5 * 1024 * 1024) { // 5 MB limit
                      Swal.fire('ขนาดไฟล์ใหญ่เกินไป', 'กรุณาเลือกรูปภาพขนาดไม่เกิน 5MB', 'warning');
                      $(this).val('');
                      return;
                 }
                const reader = new FileReader();
                reader.onload = function(event) {
                    $('#image_preview').attr('src', event.target.result);
                }
                reader.readAsDataURL(file);
            }
        });

        $('#clear-btn').on('click', clearForm);
        
        // Use submit button for updates now, handled by main form submit listener
        $('#update-btn').on('click', () => $('#personnel-form').trigger('submit')); 
        
        $('#delete-btn').on('click', () => {
            const id = $('#recordId').val();
            if(id) handleDelete(id);
        });

        // --- SEARCH ---
        $('#search-btn').on('click', function() {
            const query = $('#name-search-input').val();
            if (!query) {
                Swal.fire('กรุณาป้อนคำค้นหา', 'กรุณาป้อนชื่อหรือสกุลที่ต้องการค้นหา', 'info');
                return;
            }
            Swal.fire({
                title: 'กำลังค้นหา...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            google.script.run
                .withSuccessHandler(function(response) {
                    Swal.close();
                    console.log("Search response:", response); // เพิ่มการ log เพื่อตรวจสอบ
                    if (response && response.success && response.data) {
                        if (response.data.length === 0) {
                            Swal.fire('ไม่พบข้อมูล', 'ไม่พบข้อมูลที่ตรงกับคำค้นหา', 'info');
                        }
                        // [FIX] แก้ไขวิธีการวาดตารางใหม่ให้ชัดเจนขึ้น
                        dataTable.clear().rows.add(response.data).draw(false); // 'false' to maintain paging
                        clearForm(); // Clear form after search
                    } else {
                         const errorMessage = response ? response.message : 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์';
                        Swal.fire('ค้นหาล้มเหลว', errorMessage, 'error');
                    }
                })
                .withFailureHandler(function(err) {
                    Swal.close();
                    Swal.fire('เกิดข้อผิดพลาด', 'เชื่อมต่อเซิร์ฟเวอร์ล้มเหลว', 'error');
                })
                .searchData(query);
        });

        $('#show-all-btn').on('click', function() {
             $('#name-search-input').val(''); // Clear search input
             // [FIX] เปลี่ยนเป็นการโหลดข้อมูลทั้งหมดจากเซิร์ฟเวอร์ใหม่เพื่อความแน่นอน
             loadData(); 
             clearForm();
        });


        // --- EXPORT & PRINT ---
        $('#export-excel-btn').on('click', function() {
            // Use DataTable's internal data (what's currently shown) after sorting to export
            const dataToExport = dataTable.rows({ order: 'current' }).data().toArray();
             if (dataToExport.length === 0) {
                 Swal.fire('ไม่มีข้อมูล', 'ไม่พบข้อมูลสำหรับส่งออก (อาจต้องกด "แสดงทั้งหมด" ก่อน)', 'info');
                 return;
             }
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "PersonnelData");
            XLSX.writeFile(workbook, "Personnel_Data.xlsx");
        });

        $('#print-pdf-btn').on('click', function() {
             Swal.fire({
                 title: 'กำลังเตรียมรายงาน...',
                 text: 'กรุณารอสักครู่',
                 allowOutsideClick: false,
                 didOpen: () => { Swal.showLoading(); }
             });

            // Call a server-side function to get data with Base64 images
            google.script.run
                .withSuccessHandler(function(response) {
                    if (!response || !response.success) {
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลสำหรับพิมพ์ได้', 'error');
                        return;
                    }

                    let content = 'ยังไม่มีข้อมูล';
                    // Use the sorted data from the dataTable for printing
                    const printableData = dataTable.rows({ order: 'current' }).data().toArray();
                    
                    // Create a map of ID -> base64 image from the server response
                    const imageMap = response.data.reduce((map, item) => {
                        map[item.id] = item.profile_pic_base64;
                        return map;
                    }, {});

                    if (printableData && printableData.length > 0) {
                        content = '<table class="w-full border-collapse border border-slate-500">';
                        content += '<thead class="bg-slate-200"><tr>';
                        const headers = ["รูปภาพ", "ID", "ยศ", "ชื่อ", "สกุล", "สังกัด", "ตำแหน่ง", "เบอร์โทร"];
                        headers.forEach(h => content += `<th class="border border-slate-600 p-2">${h}</th>`);
                        content += '</tr></thead><tbody>';

                        printableData.forEach(p => {
                            const imageUrl = imageMap[p.id] ? imageMap[p.id] : 'https://placehold.co/60x60/e2e8f0/adb5bd?text=N/A';
                            content += '<tr>';
                            content += `<td class="border border-slate-700 p-2 text-center align-middle"><img src="${imageUrl}" alt="Profile" style="width:60px; height:60px; object-fit:cover; border-radius:8px; margin:auto;"></td>`;
                            content += `<td class="border border-slate-700 p-2 text-center align-middle">${p.id}</td>`;
                            content += `<td class="border border-slate-700 p-2 align-middle">${p.rank}</td>`;
                            content += `<td class="border border-slate-700 p-2 align-middle">${p.fname}</td>`;
                            content += `<td class="border border-slate-700 p-2 align-middle">${p.lname}</td>`;
                            content += `<td class="border border-slate-700 p-2 align-middle">${p.affiliation}</td>`;
                            content += `<td class="border border-slate-700 p-2 align-middle">${p.position}</td>`;
                            content += `<td class="border border-slate-700 p-2 align-middle">${p.phone}</td>`;
                            content += '</tr>';
                        });
                        content += '</tbody></table>';
                    }
                    
                    $('#printable-content').html(content);
                    
                    Swal.close();
                    
                    // Use a short timeout to let the browser render the base64 images
                    setTimeout(() => {
                        window.print();
                    }, 500);

                })
                .withFailureHandler(function(err) {
                    Swal.fire('เกิดข้อผิดพลาด', 'การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลวขณะเตรียมพิมพ์', 'error');
                })
                .getDataForPrinting(); // This is a new server-side function you need to create
        });
        
        $('#create-doc-btn').on('click', function() {
             if (!selectedRowData) {
                 Swal.fire('เกิดข้อผิดพลาด', 'กรุณาเลือกบุคลากรจากตารางก่อน', 'warning');
                 return;
             }
             Swal.fire({
                 title: 'กำลังสร้างเอกสาร Google Doc...',
                 allowOutsideClick: false,
                 didOpen: () => { Swal.showLoading(); }
             });
             
            google.script.run
                .withSuccessHandler(function(response) {
                    if(response && response.success){
                        Swal.fire({
                            title: 'สร้างเอกสารสำเร็จ!',
                            html: `คุณสามารถเปิดเอกสารได้ที่: <a href="${response.url}" target="_blank" class="text-blue-600 hover:underline">คลิกที่นี่</a>`,
                            icon: 'success'
                        });
                    } else {
                         const errorMessage = response ? response.message : 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์';
                        Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถสร้างเอกสารได้: ${errorMessage}`, 'error');
                    }
                })
                .withFailureHandler(function(error){
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว', 'error');
                })
                .createGoogleDoc(selectedRowData);
        });

        // --- INITIAL LOAD ---
        loadData();
    });
    </script>
</body>
</html>
